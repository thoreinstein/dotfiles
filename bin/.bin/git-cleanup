#!/bin/bash

# git-cleanup - Clean up merged and stale local branches
# Usage: git-cleanup
#
# This script:
# 1. Switches to the default branch (main/master)
# 2. Pulls latest changes
# 3. Deletes local branches that have been merged
# 4. Prunes remote-tracking branches
# 5. Interactively prompts to delete stale branches without remotes

set -euo pipefail

# Check for required commands
command -v git >/dev/null 2>&1 || { echo "Error: git is required but not installed" >&2; exit 1; }

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
  echo "Error: Not in a git repository" >&2
  exit 1
fi

# Get the default branch (usually main or master)
# Try local symbolic-ref first (faster), fall back to remote query
if ! DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's|refs/remotes/origin/||'); then
  # Fallback: query remote (requires network)
  DEFAULT_BRANCH=$(git remote show origin 2>/dev/null | grep "HEAD branch" | cut -d ":" -f 2 | xargs) || true
fi

if [[ -z "$DEFAULT_BRANCH" ]]; then
  echo "Error: Could not determine default branch" >&2
  exit 1
fi

# Make sure we're on the default branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null) || {
  echo "Error: Cannot determine current branch (detached HEAD state?)" >&2
  exit 1
}
if [[ "$CURRENT_BRANCH" != "$DEFAULT_BRANCH" ]]; then
  echo "Switching to $DEFAULT_BRANCH branch..."
  git checkout "$DEFAULT_BRANCH"
fi

# Update the default branch
echo "Updating $DEFAULT_BRANCH from remote..."
git pull origin "$DEFAULT_BRANCH"

# Delete all local branches that have been merged into the default branch
echo "Cleaning up merged branches..."
# Note: xargs -r is GNU-specific; use conditional execution for portability
MERGED_BRANCHES=$(git branch --merged "$DEFAULT_BRANCH" | grep -v "^\* " | grep -v "^  $DEFAULT_BRANCH$" || true)
if [[ -n "$MERGED_BRANCHES" ]]; then
  echo "$MERGED_BRANCHES" | while IFS= read -r branch; do
    branch=$(echo "$branch" | xargs)  # trim whitespace
    if [[ -n "$branch" ]]; then
      git branch -d "$branch" || echo "Warning: Could not delete branch: $branch"
    fi
  done
fi

# Delete all remote-tracking branches that no longer exist on the remote
echo "Pruning remote-tracking branches..."
git fetch --prune origin

# Get a list of all local branches (excluding current branch marker)
# Use mapfile for safe array handling with branch names
mapfile -t LOCAL_BRANCHES < <(git branch | sed 's/^\* /  /' | sed 's/^  //')

# Check each local branch
echo "Checking for stale branches..."
for branch in "${LOCAL_BRANCHES[@]}"; do
  # Skip empty entries
  [[ -z "$branch" ]] && continue
  
  # Skip the default branch
  if [[ "$branch" == "$DEFAULT_BRANCH" ]]; then
    continue
  fi
  
  # Check if the branch has a remote counterpart (use -F for literal match)
  if git branch -r | grep -qF "origin/$branch"; then
    continue
  fi
  
  # Check when the branch was last committed to
  LAST_COMMIT_DATE=$(git log -1 --format=%cd --date=relative "$branch" 2>/dev/null) || LAST_COMMIT_DATE="unknown"
  echo "Branch '$branch' has no remote and was last modified $LAST_COMMIT_DATE"
  
  # Ask if the user wants to delete this branch
  read -r -p "Delete branch '$branch'? (y/N) " response
  if [[ "$response" =~ ^[Yy] ]]; then
    git branch -D "$branch"
  fi
done

echo "Git cleanup complete!"